<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n-agent - OAuth Callback</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .success {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
            margin: 20px 0;
        }
        .info {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #4285f4;
            margin: 20px 0;
        }
        .error {
            background: #ffebee;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #f44336;
            margin: 20px 0;
        }
        code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            display: block;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .button {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 5px;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .button:hover {
            background: #5568d3;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ n-agent - OAuth Callback</h1>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Trocando c√≥digo por tokens...</p>
        </div>
        
        <div id="content"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        const content = document.getElementById('content');
        const loading = document.getElementById('loading');

        if (error) {
            content.innerHTML = `
                <div class="error">
                    <h3>‚ùå Erro no OAuth</h3>
                    <p><strong>Erro:</strong> ${error}</p>
                    <p><strong>Descri√ß√£o:</strong> ${errorDescription || 'Nenhuma descri√ß√£o dispon√≠vel'}</p>
                </div>
                <a href="test-google-login.html" class="button">‚Üê Voltar para Login</a>
            `;
        } else if (code) {
            content.innerHTML = `
                <div class="success">
                    <h3>‚úÖ Login com Google realizado com sucesso!</h3>
                    <p>Authorization code recebido do Cognito.</p>
                </div>

                <div class="info">
                    <h3>üìã Authorization Code</h3>
                    <code>${code}</code>
                    <p style="margin-top: 15px;"><strong>O que √© isso?</strong><br>
                    Este c√≥digo pode ser trocado por tokens de acesso (access_token, id_token, refresh_token) usando o endpoint OAuth2 do Cognito.</p>
                </div>

                <button onclick="exchangeCodeForTokens()" class="button">üîÑ Trocar por Tokens</button>
                <a href="test-google-login.html" class="button" style="background: #999;">‚Üê Voltar</a>

                <div id="tokens"></div>
            `;
        } else {
            content.innerHTML = `
                <div class="info">
                    <h3>‚ÑπÔ∏è Nenhum c√≥digo encontrado</h3>
                    <p>Esta p√°gina deve ser acessada ap√≥s o login OAuth.</p>
                </div>
                <a href="test-google-login.html" class="button">‚Üê Ir para Login</a>
            `;
        }

        async function exchangeCodeForTokens() {
            const code = urlParams.get('code');
            loading.style.display = 'block';
            document.getElementById('tokens').innerHTML = '';

            try {
                // Configura√ß√µes do Cognito
                const cognitoDomain = 'n-agent-prod.auth.us-east-1.amazoncognito.com';
                const clientId = '2dahku4tn0o2ntkap2imqn6322';
                const redirectUri = 'http://localhost:3000/callback';

                // Troca o code por tokens
                const tokenEndpoint = `https://${cognitoDomain}/oauth2/token`;
                
                const body = new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: clientId,
                    code: code,
                    redirect_uri: redirectUri
                });

                const response = await fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body.toString()
                });

                loading.style.display = 'none';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_description || errorData.error || 'Erro desconhecido');
                }

                const tokens = await response.json();

                // Decodifica o ID Token para ver os dados do usu√°rio
                const idTokenPayload = JSON.parse(atob(tokens.id_token.split('.')[1]));

                document.getElementById('tokens').innerHTML = `
                    <div class="success">
                        <h3>üéâ Tokens obtidos com sucesso!</h3>
                        
                        <h4>üë§ Dados do Usu√°rio (ID Token)</h4>
                        <code>${JSON.stringify(idTokenPayload, null, 2)}</code>

                        <h4>üîë Access Token</h4>
                        <code>${tokens.access_token.substring(0, 100)}...</code>

                        <h4>üÜî ID Token</h4>
                        <code>${tokens.id_token.substring(0, 100)}...</code>

                        <h4>üîÑ Refresh Token</h4>
                        <code>${tokens.refresh_token ? tokens.refresh_token.substring(0, 100) + '...' : 'N√£o fornecido'}</code>

                        <h4>‚è±Ô∏è Expira em</h4>
                        <p>${tokens.expires_in} segundos (${Math.floor(tokens.expires_in / 60)} minutos)</p>
                    </div>

                    <div class="info" style="margin-top: 20px;">
                        <h3>üß™ Testar Access Token</h3>
                        <p>Use este token para acessar rotas protegidas:</p>
                        <code>Authorization: Bearer ${tokens.access_token.substring(0, 50)}...</code>
                        <button onclick="testProtectedRoute('${tokens.access_token}')" class="button">üîí Testar Rota Protegida</button>
                    </div>

                    <div id="protected-result"></div>
                `;
            } catch (error) {
                loading.style.display = 'none';
                document.getElementById('tokens').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao trocar c√≥digo por tokens</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p><strong>Nota:</strong> Este c√≥digo provavelmente j√° foi usado ou expirou. C√≥digos OAuth s√≥ podem ser usados uma vez.</p>
                    </div>
                    <a href="test-google-login.html" class="button">‚Üê Fazer novo login</a>
                `;
            }
        }

        async function testProtectedRoute(accessToken) {
            const resultDiv = document.getElementById('protected-result');
            resultDiv.innerHTML = '<div class="loading" style="display:block;"><div class="spinner"></div><p>Testando rota protegida...</p></div>';

            try {
                const response = await fetch('https://j4f1m6rrak.execute-api.us-east-1.amazonaws.com/api/v1/trips/list', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const statusCode = response.status;
                let responseData;
                
                try {
                    responseData = await response.json();
                } catch {
                    responseData = await response.text();
                }

                if (statusCode === 403) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Autoriza√ß√£o funcionando!</h3>
                            <p><strong>Status:</strong> 403 Forbidden</p>
                            <p>O Lambda Authorizer validou seu token com sucesso! O 403 ocorre porque o backend (trip-planner) ainda n√£o est√° implementado.</p>
                            <h4>Resposta:</h4>
                            <code>${JSON.stringify(responseData, null, 2)}</code>
                        </div>
                    `;
                } else if (statusCode === 200) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Sucesso!</h3>
                            <p><strong>Status:</strong> 200 OK</p>
                            <h4>Resposta:</h4>
                            <code>${JSON.stringify(responseData, null, 2)}</code>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Erro na requisi√ß√£o</h3>
                            <p><strong>Status:</strong> ${statusCode}</p>
                            <h4>Resposta:</h4>
                            <code>${JSON.stringify(responseData, null, 2)}</code>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro na requisi√ß√£o</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
